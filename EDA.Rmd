---
title: "EDA.Rmd"
output: html_document
date: "2023-10-05"
---

The purpose of this Rmarkdown is to track function development and demonstrate their use

# Load Libraries

```{r}
library(tidyverse, quietly = TRUE)
library(readxl)
```

# Download data function

```{r}
install_avonet <- function(filename){
  
  cat("Downloading AvoNet...\n")
  
  download.file(url = "https://figshare.com/ndownloader/files/34480856?private_link=b990722d72a26b5bfead", destfile = filename, mode = "wb")

  }
```

```{r}
install_avonet(filename = "raw_data/AVONET Supplementary dataset 1.xlsx")
```

# Load AvoNet

```{r}
load_avonet <- function() {

  # store avonet as list of tibbles
  
  avonet <- list()
  
  names <- c("metadata", "birdlife", "ebird", "birdtree", 5, "raw_data", "mass_sources", "data_sources", "measurers", 10, 11)
    
  for (i in 1:11) {
  x <- setNames(list(read_xlsx("raw_data/AVONET Supplementary dataset 1.xlsx", sheet = i)), names[i])
  avonet <- append(avonet, x)
  }
  
  # Rename variables
  
  # Make variables lowercase across tibbles
  
  colnames(avonet$metadata) <- tolower(colnames(avonet$metadata))
  colnames(avonet$birdlife) <- tolower(colnames(avonet$birdlife))
  colnames(avonet$ebird) <- tolower(colnames(avonet$ebird))
  colnames(avonet$birdtree) <- tolower(colnames(avonet$birdtree))
  colnames(avonet$`5`) <- tolower(colnames(avonet$`5`))
  colnames(avonet$raw_data) <- tolower(colnames(avonet$raw_data))
  colnames(avonet$mass_sources) <- tolower(colnames(avonet$mass_sources))
  colnames(avonet$data_sources) <- tolower(colnames(avonet$data_sources))
  colnames(avonet$measurers) <- tolower(colnames(avonet$measurers))
  colnames(avonet$`10`) <- tolower(colnames(avonet$`10`))
  colnames(avonet$`11`) <- tolower(colnames(avonet$`11`))
  
  # Make variable character values lowercase in metadata tibble -> method adapted from StackOverflow (https://stackoverflow.com/questions/50615116/renaming-character-variables-in-a-column-in-data-frame-r)
  
  variable_old_name <- c(avonet$metadata$variable)

  variable_new_name <- c(tolower(avonet$metadata$variable))

  variable_lookup <- setNames(variable_new_name, variable_old_name)

  avonet$metadata$variable <- as.character(variable_lookup[avonet$metadata$variable])
  
  # Remove space in 'variable types' in metadata tibble
  
  avonet$metadata <- avonet$metadata %>% 
    rename(variable.types = `variable types`)
  
  # Return avonet
  
  return(avonet)

}
```

```{r}
avonet <- load_avonet()
```

# extract set functional traits and return summary statistics for set taxon level by set taxon system

This function is in development. Currently, the function is able to retrieve the set taxon system through the 'taxon_system' argument and can dynamically group observations by species, family, or order

```{r}
extract_avonet <- function (data,
                            taxon_system = "birdlife",
                            taxon_level = "species",
                            traits = NULL) {
  
  t_c <- taxon_system
  t_l <- taxon_level
  data <- data$raw_data
  
  # Extract taxon systems
  
  taxon_systems <- list()
  
  birdlife <- avonet$birdlife %>% 
    select(species1, family1, order1)
  
  ebird <- avonet$ebird %>% 
    select(species2, family2, order2)
  
  birdtree <- avonet$birdtree %>% 
    select(species3, family3, order3)
  
  taxon_systems$birdlife <- birdlife
  taxon_systems$ebird <- ebird
  taxon_systems$birdtree <- birdtree
  
  # Retrieve taxon system
  
  if (tolower(t_c) == "birdlife") { # use of tolower() for case insensitive if() taken from stack overflow (https://stackoverflow.com/questions/51488049/r-case-insensitive-if-check)
    
    t_system <- taxon_systems$birdlife
    
    cat("taxon system:", tolower(t_c))
    
  } else {
    
      if (tolower(t_c) == "ebird") {
      
        t_system <<- taxon_systems$ebird
        cat("taxon system:", tolower(t_c))
      
      } else {
    
          if (tolower(t_c) == "birdtree") {
        
            t_system <- taxon_systems$birdtree
            cat("taxon system:", tolower(t_c))
      
          } else {
        
              stop(paste(t_c, "is not a recognised taxonomy classification. Try 'birdlife', 'ebird', or 'birdtree'"))
        
            }
        }
    }
  
  # group data by taxon level
  
  taxon_names <- names(t_system)
  
  if (tolower(t_l) == "species") {
    
    grouping_variable_name <- paste(taxon_names[1], "_", t_c, sep = "")
    
    summary <- data %>% 
      group_by(!!sym(grouping_variable_name)) # The !!sym() code to retrieve the variable name stored in an object was written by ChatGPT
    
  } else {
    
      if (tolower(t_l) == "family" | tolower(t_l) == "order") {
        
        if (tolower(t_l) == "family") {
          
          i <- 2
          
        } else {
          
            if (tolower(t_l) == "order") {
              
              i <- 3
              
            }
          
          }
        
        grouping_variable_name <- paste(taxon_names[i], "_", t_c, sep = "")
        species_variable_name <- paste(taxon_names[1], "_", t_c, sep = "")
        
        # Lookup taxon level
        
        taxon_new <- t_system[taxon_names[i]] %>% 
          rename(taxon = taxon_names[i])
      
        taxon_species <- t_system[taxon_names[1]] %>% 
          rename(taxon = taxon_names[1])
      
        taxon_names_lookup <- setNames(c(taxon_new$taxon), c(taxon_species$taxon))
        
        # Reassign species to new taxon level
        
        data <- data %>% 
          rename(species = species_variable_name)
        
        data$species <- as.character(taxon_names_lookup[data$species])
        
        data <- data %>% 
          rename(family_order = species) # need to dynamically rename new taxon level
      
        summary <- data %>% 
          group_by(family_order)
        
      }
    
    }
  return(summary)
}
```

```{r}
summary_avonet <- extract_avonet(data = avonet, taxon_system = "birdlife", taxon_level = "family")
summary_avonet2 <- extract_avonet(data = avonet, taxon_system = "ebird", taxon_level = "species")
summary_avonet3 <- extract_avonet(data = avonet, taxon_system = "birdtree", taxon_level = "order")

summary_avonet
summary_avonet2
summary_avonet3
```
